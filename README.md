# Agentic Statistic Tool for Investment Analysis

## Overview
This project provides a FastAPI-powered service that accepts natural-language investment questions (in English), cleans uploaded or downloaded price data, and orchestrates a suite of quantitative tools (z-score spreads, RSI, SMA) to produce charts alongside LLM-generated commentary.

## Environment
Create a virtual environment and install dependencies:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Required environment variables
| Variable | Purpose |
| --- | --- |
| `OPENAI_API_KEY` | Enables LLM-powered tool selection and summary generation. Without it the app falls back to keyword heuristics. |
| `AZURE_BLOB_CONNECTION_STRING` | Optional. When provided, generated charts are uploaded to Azure Blob Storage instead of being returned as data URLs. |
| `AZURE_BLOB_CONTAINER` | Optional. Azure container name that stores generated charts. |

## Running the API

```bash
uvicorn app.main:app --reload
```

Swagger UI is available at `http://localhost:8000/docs`.

## Example request
Use multipart form fields so that the inputs are easy to supply from Swagger UI or `curl`:

```bash
curl -X POST http://localhost:8000/analysis/ \
  -F "query=Compare momentum and mean reversion between AAA and BBB" \
  -F "tickers=AAA,BBB" \
  -F "start_date=2024-01-01" \
  -F "end_date=2024-03-31" \
  -F "upload_file=@samples/prices.csv"
```

All fields except `query` are optional. If tickers are supplied, the service downloads data via `yfinance`. If a CSV is uploaded (columns: `Date`, `Ticker`, `Close`), the uploaded data is cleaned and analysed.

### Example response
```json
{
  "analysis": "Momentum remains constructive...",
  "tool_summaries": {
    "zscore": "AAA/BBB spreads are within +/-1σ, signalling a neutral stance.",
    "rsi": "AAA momentum is cooling from overbought territory.",
    "sma": "AAA remains above its 50-day SMA while BBB lags."
  },
  "images": {
    "zscore": ["https://.../analysis/abcd1234.png"],
    "rsi": ["data:image/png;base64,iVBORw0..."]
  }
}
```
The `analysis` message is generated by the LLM when an API key is present; otherwise, it is composed from tool summaries. Each tool returns one or more chart URLs. When Azure credentials are not configured, charts fall back to base64-encoded data URLs that render directly in Swagger UI.

## Query interpretation
The `AgentService` translates English queries into an actionable plan. It extracts:

- **Tools** – Recognises phrases such as “moving average”, “relative strength”, and explicit mentions of `sma`, `rsi`, or `zscore`.
- **Tickers** – Picks out upper-case ticker symbols and a small set of English company aliases (`apple`, `tesla`, `microsoft`).
- **Date windows** – Understands English relative windows such as “last six months”, “past 2y”, or “trailing 30 days” and converts them into concrete start/end dates.

If an OpenAI API key is configured the agent asks the LLM for a structured plan; otherwise, it falls back to deterministic keyword heuristics.

## Project structure
- `app/main.py` – FastAPI application setup and router inclusion.
- `app/routers/analysis.py` – Defines the `/analysis` endpoint, parses form fields, merges uploaded or downloaded price data, and coordinates the agent.
- `app/services/agent.py` – Implements the English-only agent logic: LLM-driven tool selection, fallback keyword routing, and summary generation.
- `app/services/models.py` – Lightweight data classes used to return agent results and tool payloads.
- `app/services/preprocess.py` – Utilities for parsing user uploads and normalising price matrices shared by analytics tools.
- `app/services/sources.py` – Fetches market data via `yfinance` when tickers are supplied.
- `app/services/visuals.py` – Converts matplotlib figures to URLs, optionally uploading to Azure Blob Storage.
- `app/tools/zscore.py` – Computes pairwise z-score spreads and produces heatmap/line charts.
- `app/tools/rsi.py` – Calculates relative strength indices and renders the momentum plot.
- `app/tools/sma.py` – Builds simple moving average comparisons for each ticker.
- `tests/test_analysis.py` – End-to-end tests for the analysis endpoint using the FastAPI test client.

## Testing

```bash
pytest
```
The tests require the optional `httpx` package for FastAPI's TestClient; if it is unavailable they are skipped.
